:css
  input[type=checkbox] {
    margin-top: 1px;
  }

.row-fluid
  .span12
    .title User: #{user.email}

= form_for user do |f|
  %ul
    - if current_user.has_role? :admin
      %li
        %label.checkbox
          %input{type: "checkbox", name: "roles[]", value: "admin", checked: roles.any?(&:superadmin?)}
          Superadmin
    - if institutions.present?
      %li
        Institutions
        %ul
          - institutions.each do |institution|
            - user_is_institution_admin = roles.any? { |r| r.admin_of?(institution) }
            - current_user_is_institution_admin = current_user_roles.any? { |r| r.admin_of?(institution) }
            %li
              %label.checkbox
                %input{type: "checkbox", name: "roles[]", value: "Institution-#{institution.id}", checked: user_is_institution_admin, disabled: !current_user_is_institution_admin}
                = institution.name
              %ul
                - laboratories = institution.laboratories
                - laboratories = laboratories.select { |lab| current_user_roles.any? { |r| r.admin_of?(lab) } } unless current_user_is_institution_admin
                - if laboratories.present?
                  %li
                    Laboratories
                    %ul
                      - laboratories.each do |lab|
                        %li
                          %label.checkbox
                            %input{type: "checkbox", name: "roles[]", value: "Laboratory-#{lab.id}", checked: roles.any? { |r| r.admin_of?(lab) }}
                            = lab.name
                - devices = institution.devices
                - devices = devices.select { |device| current_user_roles.any? { |r| r.admin_of?(device) } } unless current_user_is_institution_admin
                - if devices.present?
                  %li
                    Devices
                    %ul
                      - devices.each do |device|
                        %li
                          %label.checkbox
                            %input{type: "checkbox", name: "roles[]", value: "Device-#{device.id}", checked: roles.any? { |r| r.admin_of?(device) }}
                            = device.name
    - if locations.present?
      %li
        Locations
        = render "locations", locations: locations

  = f.submit class: 'btn'
