{
  "metadata" : {
    "version" : "0.0.8",
    "api_version" : "1.2.0",
    "signature" : "",
    "device_models" : ["genoscan"],
    "source": { "type" : "csv", "separator" : ";" }
  },
  "custom_fields" : [
    {
      "name": "patient.name",
      "pii" : true,
      "type" : "string"
    },
    {
      "name": "test.clia_waived_test",
      "type" : "string"
    },
    {
      "name": "test.revision",
      "type" : "string"
    },
    {
      "name": "test.control",
      "type" : "string"
    },
    {
      "name": "test.ig_type",
      "type" : "enum",
      "options" : ["ig_a", "ig_g", "ig_m", "unknown"]
    },
    {
      "name": "test.control_strip",
      "type" : "enum",
      "options" : ["patient", "cut_off", "avidity", "liquor", "positive", "negative"]
    },
    {
      "name": "test.bands",
      "type" : "string"
    }
  ],
  "field_mapping" : {
    "patient.id" : {"lookup" : "PID"},
    "patient.name" : {
      "concat" : [
          {"lookup" : "Firstname"},
          " ",
          {"lookup" : "LastName"}
      ]
    },
    "test.patient_age" : {
      "if" : [
        {"equals" : [{"lookup" : "Birthday"}, "n.a."]},
        "",
        {
          "years_between" : [
            {"parse_date" : [
              {"lookup" : "Birthday"},
              "%d.%m.%Y"
            ]},
            {"parse_date" : [
              {"lookup" : "DateOfAnalysis"},
              "%d.%m.%Y"
            ]}
          ]
        }
      ]
    },
    "patient.gender" : {
      "map" : [
        {"lookup" : "Sex"},
        [
          {"match": "*n.a.*", "output" : "unknown"},
          {"match": "*Female*", "output" : "female"},
          {"match": "*", "output" : "male"}
        ]
      ]
    },
    "sample.uid" : {
      "concat" : [
          {"lookup" : "PID"},
          "-",
          {"lookup" : "SampleNo."}
      ]
    },
    "sample.id" : {"lookup" : "SampleNo."},
    "test.start_time" : {
      "parse_date" : [
          {"lookup" : "DateOfAnalysis"},
          "%d.%m.%Y"
        ]
    },
    "device.lab_user" : {"lookup" : "WindowsUser"},
    "test.name" : {"lookup" : "TypeOfTest"},
    "test.assays[*].name" : {
      "script" : "['mtb', 'rif', 'inh']"
    },
    "test.assays[*].qualitative_result" : {
      "script" : "
        if(message['Result'].match(/.*tuberculosis.*/)){
          mtb = 'positive'
        } else {
          mtb = 'negative'
        };
        if(message['Result'].match(/.*RMP resistant.*/)){
          rif = 'positive'
        } else {
          rif = 'negative'
        };
        if(message['Result'].match(/.*INH resistant.*/)){
          inh = 'positive'
        } else {
          inh = 'negative'
        };
        [mtb, rif, inh]"
    },
    "test.type" : {
      "map" : [
        {"lookup" : "Strip-Type"},
        [
          {"match": "*Patient*", "output" : "specimen"},
          {"match": "*", "output" : "qc"}
        ]
      ]
    },
    "test.clia_waived_test" : {"lookup" : "CW"},
    "test.revision" : {"lookup" : "Revision"},
    "test.control" : {"lookup" : "Control"},
    "test.ig_type" : {
      "map" : [
        {"lookup" : "Ig-Type"},
        [
          {"match": "*IgA*", "output" : "ig_a"},
          {"match": "*IgG*", "output" : "ig_g"},
          {"match": "*IgM*", "output" : "ig_m"},
          {"match": "*", "output" : "unknown"}
        ]
      ]
    },
    "test.control_strip" : {
      "map" : [
        {"lookup" : "Strip-Type"},
        [
          {"match": "*Patient*", "output" : "patient"},
          {"match": "*Cut-Off*", "output" : "cut_off"},
          {"match": "*Avidity*", "output" : "avidity"},
          {"match": "*Liquor*", "output" : "liquor"},
          {"match": "*Positive*", "output" : "positive"},
          {"match": "*Negative*", "output" : "negative"}
        ]
      ]
    },
    "test.bands" : {"lookup" : "Bands"}
  }
}
