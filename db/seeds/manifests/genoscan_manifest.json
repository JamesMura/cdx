{
  "metadata" : {
    "version" : "0.0.8",
    "api_version" : "1.1.0",
    "signature" : "",
    "device_models" : ["genoscan"],
    "source": { "type" : "csv", "separator" : ";" }
  },
  "field_mapping" : {
    "patient" : [
      {
        "target_field": "patient_id",
        "source" : {"lookup" : "PID"},
        "core" : true,
        "pii" : true,
        "type" : "string"
      },
      {
        "target_field": "patient_name",
        "source" : {
          "concat" : [
              {"lookup" : "Firstname"},
              " ",
              {"lookup" : "LastName"}
          ]
        },
        "core" : true,
        "pii" : true,
        "type" : "string"
      },
      {
        "target_field": "age",
        "source" :  { "if" : [
          {"equals" : [{"lookup" : "Birthday"}, "n.a."]},
          "",
          {
            "years_between" : [
              {"parse_date" : [
                {"lookup" : "Birthday"},
                "%d.%m.%Y"
              ]},
              {"parse_date" : [
                {"lookup" : "DateOfAnalysis"},
                "%d.%m.%Y"
              ]}
            ]
          }
        ]},
        "core" : true,
        "indexed" : true,
        "type" : "integer"
      },
      {
        "target_field": "gender",
        "source" : {
          "map" : [
            {"lookup" : "Sex"},
            [
              {"match": "*n.a.*", "output" : "unknown"},
              {"match": "*Female*", "output" : "female"},
              {"match": "*", "output" : "male"}
            ]
          ]
        },
        "core" : true,
        "indexed" : true,
        "type" : "enum",
        "options" : ["male", "female", "unknown"]
      }
    ],
    "sample" : [
      {
        "target_field": "sample_uid",
        "source" : {
          "concat" : [
              {"lookup" : "PID"},
              "-",
              {"lookup" : "SampleNo."}
          ]
        },
        "core" : true,
        "pii" : true,
        "type" : "string"
      },
      {
        "target_field": "sample_id",
        "source" : {"lookup" : "SampleNo."},
        "core" : true,
        "pii" : true,
        "type" : "string"
      }
    ],
    "test" : [
      {
        "target_field": "start_time",
        "source" : {
          "parse_date" : [
              {"lookup" : "DateOfAnalysis"},
              "%d.%m.%Y"
            ]
        },
        "core" : true,
        "indexed" : true,
        "type" : "date"
      },
      {
        "target_field": "system_user",
        "source" : {"lookup" : "WindowsUser"},
        "core" : true,
        "indexed" : true,
        "type" : "string"
      },
      {
        "target_field": "assay_name",
        "source" : {"lookup" : "TypeOfTest"},
        "core" : true,
        "indexed" : true,
        "type" : "string"
      },
      {
        "target_field" : "results[*].condition",
        "source" : {
          "map" : [
            {"lookup" : "TypeOfTest"},
            [
              {"match": "MTBDRplus", "output" : "mtb"}
            ]
          ]
        },
        "type" : "enum",
        "core" : true,
        "indexed" : true,
        "options" : [
          "mtb"
        ]
      },
      {
        "target_field" : "results[*].result",
        "source" : {
          "map" : [
            {"lookup" : "Result"},
            [
              {"match": "*RMP resistant*INH resistant*", "output" : "positive_with_rif_and_inh"},
              {"match": "*RMP resistant*INH sensitive*", "output" : "positive_with_rif"},
              {"match": "*RMP sensitive*INH resistant*", "output" : "positive_with_inh"},
              {"match": "*RMP sensitive*INH sensitive*", "output" : "positive"},
              {"match": "*tuberculosis*", "output" : "positive"},
              {"match": "*", "output" : "negative"}
            ]
          ]
        },
        "type" : "enum",
        "core" : true,
        "indexed" : true,
        "options" : [
          "positive",
          "positive_with_rif_and_inh",
          "positive_with_rif",
          "positive_with_inh",
          "negative"
        ]
      },
      {
        "target_field": "test_type",
        "source" : {
          "map" : [
            {"lookup" : "Strip-Type"},
            [
              {"match": "*Patient*", "output" : "specimen"},
              {"match": "*", "output" : "qc"}
            ]
          ]
        },
        "core" : true,
        "indexed" : true,
        "type" : "enum",
        "options" : ["specimen", "qc"]
      },
      {
        "target_field": "clia_waived_test",
        "source" : {"lookup" : "CW"},
        "indexed" : true,
        "type" : "string"
      },
      {
        "target_field": "revision",
        "source" : {"lookup" : "Revision"},
        "type" : "string"
      },
      {
        "target_field": "control",
        "source" : {"lookup" : "Control"},
        "type" : "string"
      },
      {
        "target_field": "ig_type",
        "source" : {
          "map" : [
            {"lookup" : "Ig-Type"},
            [
              {"match": "*IgA*", "output" : "ig_a"},
              {"match": "*IgG*", "output" : "ig_g"},
              {"match": "*IgM*", "output" : "ig_m"},
              {"match": "*", "output" : "unknown"}
            ]
          ]
        },
        "type" : "enum",
        "options" : ["ig_a", "ig_g", "ig_m", "unknown"]
      },
      {
        "target_field": "control_strip",
        "source" : {
          "map" : [
            {"lookup" : "Strip-Type"},
            [
              {"match": "*Patient*", "output" : "patient"},
              {"match": "*Cut-Off*", "output" : "cut_off"},
              {"match": "*Avidity*", "output" : "avidity"},
              {"match": "*Liquor*", "output" : "liquor"},
              {"match": "*Positive*", "output" : "positive"},
              {"match": "*Negative*", "output" : "negative"}
            ]
          ]
        },
        "type" : "enum",
        "options" : ["patient", "cut_off", "avidity", "liquor", "positive", "negative"]
      },
      {
        "target_field": "bands",
        "source" : {"lookup" : "Bands"},
        "type" : "string"
      }
    ]
  }
}
